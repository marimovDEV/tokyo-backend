â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                   â•‘
â•‘      ğŸš€ TOKYO KAFE - VERCEL + BEGET TEZKOR YECHIM ğŸš€          â•‘
â•‘                                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ğŸ“ ARXITEKTURA
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  Frontend:  https://tokyokafe.vercel.app  (Next.js)
             â†“
  Backend:   https://tokyokafe.uz          (Django + Beget)


âŒ SIZNING MUAMMOLARINGIZ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  1. âŒ CSRF Error (403 Forbidden)
     â†’ "Origin does not match any trusted origins"

  2. âŒ CORS Error
     â†’ "No 'Access-Control-Allow-Origin' header"

  3. âŒ Too Many Requests (ERR_INSUFFICIENT_RESOURCES)
     â†’ Fetch loop

  4. âŒ 404 logo.png
     â†’ Static files muammosi

  5. âŒ Rasmlar sekin
     â†’ Optimization kerak


âœ… YECHIM - 2 QADAMDA (10 DAQIQA)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1ï¸âƒ£  BACKEND (Beget) - 8 daqiqa
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ssh u1234567@tokyokafe.uz
cd ~/public_html/backend

# A. django-cors-headers o'rnatish
source venv/bin/activate
pip install django-cors-headers
pip freeze > requirements.txt

# B. settings.py ni tahrirlash
nano restaurant_api/settings.py

# Quyidagilarni qo'shing yoki almashtiring:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# 1. INSTALLED_APPS ga qo'shing:
INSTALLED_APPS = [
    'corsheaders',  # â† YANGI
    ...
]

# 2. MIDDLEWARE ga qo'shing (eng yuqorida):
MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',  # â† YANGI, ENG YUQORI
    'django.middleware.common.CommonMiddleware',
    ...
]

# 3. CSRF Settings:
CSRF_TRUSTED_ORIGINS = [
    "https://tokyokafe.uz",
    "https://tokyokafe.vercel.app",   # â† YANGI
    "https://*.vercel.app",            # â† Preview URLs uchun
]

CSRF_COOKIE_SECURE = True
CSRF_COOKIE_HTTPONLY = False      # â† FALSE qiling
CSRF_COOKIE_SAMESITE = 'None'     # â† 'None' qiling

# 4. Session Settings:
SESSION_COOKIE_SECURE = True
SESSION_COOKIE_SAMESITE = 'None'  # â† 'None' qiling

# 5. CORS Settings:
CORS_ALLOWED_ORIGINS = [
    "https://tokyokafe.vercel.app",
    "https://*.vercel.app",
    "http://localhost:3000",  # Development
]

CORS_ALLOW_CREDENTIALS = True     # â† MUHIM!

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# C. CSRF endpoint yaratish
nano views.py

# Qo'shing:
from django.views.decorators.csrf import ensure_csrf_cookie
from django.http import JsonResponse

@ensure_csrf_cookie
def get_csrf_token(request):
    return JsonResponse({'csrfToken': request.META.get('CSRF_COOKIE')})

# urls.py ga:
path('api/csrf/', views.get_csrf_token, name='csrf'),

# D. Backend restart
bash restart_beget.sh

# E. Test
curl https://tokyokafe.uz/api/menu/


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
2ï¸âƒ£  FRONTEND (Vercel) - 2 daqiqa
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# A. Environment Variable (Vercel dashboard)
Settings â†’ Environment Variables â†’ Add:

  NEXT_PUBLIC_API_URL = https://tokyokafe.uz

# B. Barcha fetch ga qo'shing:

fetch('https://tokyokafe.uz/api/...', {
  credentials: 'include',  // â† MUHIM!
})

# C. POST request uchun CSRF token:

const csrfToken = getCookie('csrftoken')

fetch('https://tokyokafe.uz/api/cart/add/', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRFToken': csrfToken,  // â† Qo'shing
  },
  credentials: 'include',      // â† MUHIM!
  body: JSON.stringify(data),
})

# D. useEffect dependency to'g'rilash:

useEffect(() => {
  fetchMenu()
}, [])  // â† [] qo'ying (loop bo'lmasligi uchun)

# E. Deploy
git add .
git commit -m "Fix CORS and CSRF"
git push origin main


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ğŸ§ª TEKSHIRISH
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# 1. Backend API test
curl https://tokyokafe.uz/api/menu/
# Natija: 200 OK, JSON data

# 2. CSRF token test
curl https://tokyokafe.uz/api/csrf/
# Natija: {"csrfToken": "..."}

# 3. Frontend test (Browser console)
fetch('https://tokyokafe.uz/api/menu/', {credentials: 'include'})
  .then(r => r.json())
  .then(d => console.log(d))
# Natija: Menu data

# 4. Browser DevTools â†’ Network
# Headers da ko'ring:
#   - Request: Cookie, X-CSRFToken
#   - Response: Set-Cookie


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ğŸ“š TO'LIQ QOLLANMALAR
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  ğŸ“– VERCEL_BEGET_GUIDE.md
     â†’ To'liq qo'llanma (10 daqiqa)

  ğŸ“„ settings_vercel.py
     â†’ Django settings to'liq versiya (copy-paste qiling)

  ğŸŒ nginx_vercel.conf
     â†’ Nginx konfiguratsiya (CORS headers bilan)

  ğŸ’» frontend_fetch_examples.js
     â†’ Frontend kod misollar (SWR, React Query)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ğŸ”¥ MASLAHATLAR
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  1. credentials: 'include' ni HAMMA fetch ga qo'shing
  
  2. CSRF_COOKIE_SAMESITE = 'None' bo'lishi KERAK
     (Lax yoki Strict cross-domain ishlamaydi)
  
  3. corsheaders.middleware.CorsMiddleware
     MIDDLEWARE ning eng yuqorisida bo'lishi kerak
  
  4. useEffect(() => {...}, []) dependency [] bo'lishi kerak
     (bo'lmasa cheksiz loop)
  
  5. Vercel Environment Variables ga API_URL qo'shing


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ğŸ› AGAR HALI HAM ISHLAMASA
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# 1. Backend logs tekshirish
tail -50 ~/public_html/backend/logs/gunicorn_error.log

# 2. Browser DevTools â†’ Network
# Birinchi request: /api/csrf/ (cookie olish)
# Keyingi requests: X-CSRFToken header bormi?

# 3. CORS test (Browser console)
fetch('https://tokyokafe.uz/api/menu/', {credentials: 'include'})

# 4. Backend restart
bash restart_beget.sh

# 5. Browser cache tozalash
Ctrl+Shift+R (yoki Cmd+Shift+R)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


ğŸ“Š MONITORING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Backend logs
tail -f ~/public_html/backend/logs/gunicorn_error.log

# Server resources
bash check_resources.sh

# Backend restart
bash restart_beget.sh


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


âœ… YAKUNIY CHECKLIST
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Backend (Beget):
  â–¡ django-cors-headers o'rnatilgan
  â–¡ CSRF_TRUSTED_ORIGINS ga Vercel URL qo'shilgan
  â–¡ CSRF_COOKIE_SAMESITE = 'None'
  â–¡ SESSION_COOKIE_SAMESITE = 'None'
  â–¡ CORS_ALLOW_CREDENTIALS = True
  â–¡ corsheaders MIDDLEWARE da
  â–¡ /api/csrf/ endpoint yaratilgan
  â–¡ Backend restart qilingan

Frontend (Vercel):
  â–¡ NEXT_PUBLIC_API_URL environment variable
  â–¡ credentials: 'include' barcha fetch da
  â–¡ X-CSRFToken header POST da
  â–¡ useEffect dependency []
  â–¡ Deploy qilingan

Test:
  â–¡ curl https://tokyokafe.uz/api/menu/ â†’ 200 OK
  â–¡ Browser da fetch test â†’ data keladi
  â–¡ CORS error yo'q
  â–¡ CSRF error yo'q


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

              MUVAFFAQIYATLI DEPLOY! ğŸ‰

           Tokyo Kafe ğŸ½ï¸ | Vercel + Beget | 2025

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

